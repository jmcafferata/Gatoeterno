<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Stock de libros</title>
    <link rel="stylesheet" href="static/styles.css" />
  </head>
  <body>
    <div class="module">
      <!-- Barra de búsqueda -->
      <input type="text" id="search" placeholder="Buscar..." />
      <!-- Lista de resultados -->
      <table id="results"></table>
    </div>
    <div class="module">
      <!-- Selección de artículos -->
      <table id="selection"></table>
      <!-- Botón de Agregar a stock -->
      <button id="add">Agregar a stock</button>
      <!-- Botón de Registrar venta -->
      <button id="sell">Registrar venta</button>
      <!-- Botón de Borrar selección -->
      <button id="clear">Borrar selección</button>
    </div>
    <div class="module">
      <!-- Botón de Subir factura-->
      <button id="upload">Subir factura</button>
      <!-- Botón de Historial-->
      <button id="history">Historial</button>
      <!-- Botón de agregar a stock manual-->
      <button id="manual">Agregar a stock</button>
      <!-- Botón de aumentar precios -->
      <button id="increase">Aumentar precios</button>
    </div>

    <script type="text/javascript">
      let selection = [];
      // append selection.json items to the array
      fetch("selection.json")
        .then((response) => response.json())
        .then((json) => {
          selection = json;
          // append selection items to the selection table
          fillSelectionTable();
        });

      // When user clicks on the add button, add the selected items to the stock
      document.getElementById("add").addEventListener("click", function () {
        // add selected items to stock.json (if isbn already exists, add cantidad)
        fetch("/update-stock", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(selection),
        })
          .then((response) => response.text())
          .then((data) => {
            console.log(data); // Log the server's response for debugging
          })
          .catch((error) => {
            console.error("Error:", error);
          });

        // clear the selection
        selection = [];
        // clear the selection table
        document.getElementById("selection").innerHTML = "";
      });

      // When user types anything anywhere, it types in the search bar
      document.addEventListener("keydown", function (e) {
        // if the user is typing in the search bar and presses enter, check if the text is a valid ISBN
        if (e.target.id == "search" && e.keyCode == 13) {
          // if the text is a valid ISBN, add it to the selection
          if (isValidISBN(document.getElementById("search").value)) {
            // check if the ISBN is already in the selection
          } else {
            alert("ISBN inválido");
            // TODO handle invalid ISBN
          }
          // clear the search bar
          document.getElementById("search").value = "";
        }
        if (e.target.id == "search") {
          return;
        }
        document.getElementById("search").focus();
      });

      // Fill selection table
      function fillSelectionTable() {
        let properties = [];
        // For each item in the selection array, store the properties in an array called properties (don't repeat properties)
        for (let i = 0; i < selection.length; i++) {
          for (let property in selection[i]) {
            if (properties.indexOf(property) == -1) {
              properties.push(property);
            }
          }
        }
        // Create the table header
        let table = document.getElementById("selection");
        let header = table.createTHead();
        let row = header.insertRow(0);
        for (let i = 0; i < properties.length; i++) {
          let cell = row.insertCell(i);
          cell.innerHTML = properties[i];
        }
        // Create the table body
        let body = table.createTBody();
        for (let i = 0; i < selection.length; i++) {
          let row = body.insertRow(i);
          for (let j = 0; j < properties.length; j++) {
            let cell = row.insertCell(j);
            // if property undefined, set cell to empty string
            if (selection[i][properties[j]] == undefined) {
              cell.innerHTML = "";
            } else {
              cell.innerHTML = selection[i][properties[j]];
            }
          }
        }
      }

      // Check if a string is a valid ISBN
      function isValidISBN(isbn) {
        // remove all non-digit characters
        isbn = isbn.replace(/\D/g, "");
        // if the string is not 10 or 13 characters long, it's not a valid ISBN
        if (isbn.length != 10 && isbn.length != 13) {
          return false;
        }
        // if the string is 10 characters long, it must be a valid ISBN-10
        if (isbn.length == 10) {
          // calculate the check digit
          var sum = 0;
          for (var i = 0; i < 9; i++) {
            sum += parseInt(isbn[i]) * (10 - i);
          }
          var check = (11 - (sum % 11)) % 11;
          // if the check digit is 10, it must be an X
          if (check == 10) {
            return isbn[9] == "X";
          }
          // otherwise, it must be a digit
          return isbn[9] == check;
        }
        // if the string is 13 characters long, it must be a valid ISBN-13
        if (isbn.length == 13) {
          // calculate the check digit
          var sum = 0;
          for (var i = 0; i < 12; i++) {
            sum += parseInt(isbn[i]) * (i % 2 == 0 ? 1 : 3);
          }
          var check = (10 - (sum % 10)) % 10;
          // the check digit must be a digit
          return isbn[12] == check;
        }
      }
    </script>

    <style>
      .module {
        background-color: #eff2f7;
        border-radius: 5px;
        padding: 10px;
        margin: 10px;
      }
    </style>
  </body>
</html>
